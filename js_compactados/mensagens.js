function carregaMensagens(){dataMensagens=getData("Mensagens/email",usuarioId),dataMensagensEntrada=getData("Mensagens/email/entrada",usuarioId),dataMensagensSaida=getData("Mensagens/email/enviado",usuarioId)}function selecionarMensagem(a){$("#Col_CaixaDeMensagens div").removeClass("msg_selecionada"),$(a).toggleClass("msg_selecionada"),$(a).removeClass("nao_lida").addClass("lida"),MostrarMensagem($(a).attr("msgId"))}function setMSGSend(a){console.log(a),$("#Nova_frame").hide(),$("#Resp_frame").hide();for(var b=0;b<dataMensagens.length;b++)dataMensagens[b].idmensagens==SelMSGAcao&&(1==a?($("#Resp_frame").show(),$("#tela_over #Mensagem_wrapper #Resp_frame #mensagem_remetente").html(null!=dataMensagens[b].remetente.aluno?dataMensagens[b].remetente.aluno.nome:dataMensagens[b].remetente.professor.nome),$("#telxa_over #Mensagem_wrapper #Resp_frame #mensagem_destinatario").html(getNomeByNomeUsuario(dataMensagens[b].destinatarios,0)),$("#tela_over #Mensagem_wrapper #Resp_frame #Resposta_Remetente").val(dataMensagens[b].remetente.idusuario),$("#tela_over #Mensagem_wrapper #Resp_frame #mensagem_assunto").html(dataMensagens[b].assunto),$("#tela_over #Mensagem_wrapper #Resp_frame #Mensagem").val("\n\n-------------------------------------------------\n"+dataMensagens[b].mensagem)):2==a?($("#Nova_frame").show(),getNomeByNomeUsuario(dataMensagens[b].destinatarios,1),$("#tela_over #Mensagem_wrapper #Nova_frame #destinatarios option[value='"+dataMensagens[b].remetente.idusuario+"']").prop("selected",!0),$("#tela_over #Mensagem_wrapper #Nova_frame #destinatarios option[value='"+userID+"']").prop("selected",!1),formselect.multiselect("refresh"),$("#tela_over #Mensagem_wrapper #Nova_frame #assunto").val("RES: "+dataMensagens[b].assunto),$("#tela_over #Mensagem_wrapper #Nova_frame #mensagem").empty(),$("#tela_over #Mensagem_wrapper #Nova_frame #mensagem").val("\n\n-------------------------------------------------\n"+dataMensagens[b].mensagem)):3==a&&($("#Nova_frame").show(),$("#tela_over #Mensagem_wrapper #Nova_frame #assunto").val(dataMensagens[b].assunto),$("#tela_over #Mensagem_wrapper #Nova_frame #mensagem").empty(),$("#tela_over #Mensagem_wrapper #Nova_frame #mensagem").val("\n\n-------------------------------------------------\nDe: "+(null!=dataMensagens[b].remetente.aluno?dataMensagens[b].remetente.aluno.nome:dataMensagens[b].remetente.professor.nome)+"\nPara: "+getNomeByNomeUsuario(dataMensagens[b].destinatarios,0)+"\n\n"+dataMensagens[b].mensagem)));4==a&&($("#Nova_frame").show(),$("#tela_over #Mensagem_wrapper #Nova_frame #assunto").empty(),$("#tela_over #Mensagem_wrapper #Nova_frame #mensagem").empty())}function MostrarMensagem(a){PLixo=a;for(var d=getData("Mensagens/email",usuarioId),e=0;e<d.length;e++)d[e].idmensagens==a&&($("#Col_Mensagem #Mensagem_wrapper #mensagem_remetente").html(null!=d[e].remetente.aluno?d[e].remetente.aluno.nome:d[e].remetente.professor.nome),$("#Col_Mensagem #Mensagem_wrapper #mensagem_destinatario").html(getNomeByNomeUsuario(d[e].destinatarios)),$("#Col_Mensagem #Mensagem_wrapper #Resposta_Remetente").val(d[e].remetente.idusuario),$("#Col_Mensagem #Mensagem_wrapper #mensagem_assunto").html(d[e].assunto),$("#Col_Mensagem #Mensagem_wrapper #Mensagem").html(d[e].mensagem),SelMSGAcao=a,"N"==d[e].lida&&$.ajax({url:path+"Mensagens/update/lida/"+a+"/S",type:"POST",success:function(){d=getData("Mensagens",null)},error:function(){d=getData("Mensagens",null)}}))}function enviar(){loading("inicial"),EnviarMSG()}function EnviarMSG(){return $("#frm_Envia_Mensagens #remetente").attr("value",""+userID),null!=$("#frm_Envia_Mensagens #destinatarios").val()&&""!=$("#frm_Envia_Mensagens #mensagem").val()&&""!=$("#frm_Envia_Mensagens #assunto").val()?$.ajax({url:path+"Mensagens/",type:"POST",data:$("#frm_Envia_Mensagens").serialize(),success:function(a){return observacaoProducao&&($.ajax({url:path+"ProducaoAluno/Status/"+localStorage.getItem("observacaoProducao")+"/2/"+(a-1),type:"GET",async:!0,crossDomain:!0,beforeSend:function(){loading("inicial")},success:function(){},erro:function(){mensagem("N\xe3o modificado","OK","bt_ok","erro")},complete:function(){loading("final")}}),observacaoProducao=!1),$("#tela_over").hide(),mensagem("Mensagem enviada com sucesso!","OK","bt_ok","sucesso"),ListarEnviadas(""),limparCampos(),loading("final"),!1},error:function(){mensagem("Erro ao enviar mensagem!","OK","bt_ok","erro"),loading("final")}}):null==$("#frm_Envia_Mensagens #destinatarios").val()?(mensagem("N\xe3o h\xe1 destinat\xe1rios, por favor, adicione ao menos um destinat\xe1rio!","OK","bt_ok","erro"),loading("final")):""==$("#frm_Envia_Mensagens #assunto").val()?(mensagem("N\xe3o h\xe1 assunto, por favor, adicione um assunto que deseja enviar!","OK","bt_ok","erro"),loading("final")):""==$("#frm_Envia_Mensagens #mensagem").val()&&(mensagem("N\xe3o h\xe1 mensagem, por favor, adicione a mensagem que deseja enviar!","OK","bt_ok","erro"),loading("final")),!1}function ResponderMensagem(){$("#frm_Envia_Mensagens #remetente").attr("value",""+userID),""!=$("#tela_over #Mensagem").val()?$.ajax({url:path+"Mensagens/",type:"POST",data:"id=0&action=create&lida=1&remetente="+userID+"&assunto=RE: "+$("#tela_over #mensagem_assunto").html()+"&destinatarios="+$("#tela_over #Resposta_Remetente").val()+"&mensagem="+$("#tela_over #Mensagem").val(),success:function(){dataMensagens=getData("Mensagens",null),$("#tela_over").hide(),$("#CaixaDeEntrada").trigger("click"),ListarCaixaEntrada(),mensagem("Mensagem enviada com sucesso!","OK","bt_ok","sucesso")},error:function(){mensagem("Erro ao enviar mensagem!","OK","bt_ok","erro"),loading("final"),dataMensagens=getData("Mensagens",null)}}):(mensagem("Sua resposta n\xe3o tem mensagem, por favor, adicione uma!","OK","bt_ok","erro"),loading("final"))}function ListarCaixaEntrada(){carregaMensagens();for(var a="",b=1,c=dataMensagensEntrada.length-1;c>=0;c--){var d=dataMensagensEntrada[c].data.substr(8,2)+"/"+dataMensagensEntrada[c].data.substr(5,2)+"/"+dataMensagensEntrada[c].data.substr(0,4);"Aluno"==usuario&&null!=dataMensagensEntrada[c].proprietario.aluno?dataMensagensEntrada[c].proprietario.idusuario==userID&&"S"==dataMensagensEntrada[c].cxEntrada&&(a+='<div id="msg'+b++ +'" class="caixa_mensagem'+("N"==dataMensagensEntrada[c].lida?" nao_lida":" lida")+'" msgId="'+dataMensagensEntrada[c].idmensagens+'" onclick="selecionarMensagem(this);"> <div class="caixa_data_hora"> '+d+' </div><div class="msg_info_wrapper"><div class="caixa_remetente"> '+(null!=dataMensagensEntrada[c].remetente.aluno?dataMensagensEntrada[c].remetente.aluno.nome:dataMensagensEntrada[c].remetente.professor.nome)+' </div><div class="caixa_assunto"> '+(""!=dataMensagensEntrada[c].assunto?dataMensagensEntrada[c].assunto:"Sem Assunto")+"</div></div></div>"):"Professor"!=usuario&&"Coordenacao"!=usuario&&"Secretaria"!=usuario||null==dataMensagensEntrada[c].proprietario.professor||dataMensagensEntrada[c].proprietario.idusuario==userID&&"S"==dataMensagensEntrada[c].cxEntrada&&(a+='<div id="msg'+b++ +'" class="caixa_mensagem'+("N"==dataMensagensEntrada[c].lida?" nao_lida":" lida")+'" msgId="'+dataMensagensEntrada[c].idmensagens+'" onclick="selecionarMensagem(this);"> <div class="caixa_data_hora"> '+d+' </div><div class="msg_info_wrapper"><div class="caixa_remetente"> '+(null!=dataMensagensEntrada[c].remetente.aluno?dataMensagensEntrada[c].remetente.aluno.nome:dataMensagensEntrada[c].remetente.professor.nome)+' </div><div class="caixa_assunto"> '+(""!=dataMensagensEntrada[c].assunto?dataMensagensEntrada[c].assunto:"Sem Assunto")+"</div></div></div>")}$("#Col_CaixaDeMensagens").html(a)}function ListarEnviadas(a){carregaMensagens();for(var b="",c=1,d=dataMensagensSaida.length-1;d>=0;d--){var e=dataMensagensSaida[d].data.substr(8,2)+"/"+dataMensagensSaida[d].data.substr(5,2)+"/"+dataMensagensSaida[d].data.substr(0,4);"Aluno"==usuario&&null!=dataMensagensSaida[d].remetente.aluno?dataMensagensSaida[d].remetente.idusuario==userID&&"S"==dataMensagensSaida[d].cxEnviada&&(b+='<div id="msg'+c++ +'" class="caixa_mensagem'+("N"==dataMensagensSaida[d].lida?" nao_lida":" lida")+'" msgId="'+dataMensagensSaida[d].idmensagens+'" onclick="selecionarMensagem(this);"> <div class="caixa_data_hora"> '+e+' </div><div class="msg_info_wrapper"><div class="caixa_remetente"> '+dataMensagensSaida[d].remetente.aluno.nome+' </div><div class="caixa_assunto"> '+(""!=dataMensagensSaida[d].assunto?dataMensagensSaida[d].assunto:"Sem Assunto")+"</div></div></div>"):"Professor"!=usuario&&"Coordenacao"!=usuario&&"Secretaria"!=usuario||null==dataMensagensSaida[d].remetente.professor||dataMensagensSaida[d].remetente.idusuario==userID&&"S"==dataMensagensSaida[d].cxEnviada&&(b+='<div id="msg'+c++ +'" class="caixa_mensagem'+("N"==dataMensagensSaida[d].lida?" nao_lida":" lida")+'" msgId="'+dataMensagensSaida[d].idmensagens+'" onclick="selecionarMensagem(this);"> <div class="caixa_data_hora"> '+e+' </div><div class="msg_info_wrapper"><div class="caixa_remetente"> '+dataMensagensSaida[d].remetente.professor.nome+' </div><div class="caixa_assunto"> '+(""!=dataMensagensSaida[d].assunto?dataMensagensSaida[d].assunto:"Sem Assunto")+"</div></div></div>")}var f;f=""!=a?a+b:b,$("#Col_CaixaDeMensagens").html(f)}function ExcluirMensagem(){PLixo>0&&$.ajax({type:"GET",async:!1,crossDomain:!0,url:path+"Mensagens/delete/"+PLixo,success:function(){PLixo=0},error:function(a){405==a.status&&(PLixo=0,$(".msg_selecionada").next().addClass("nextAccept"),$(".msg_selecionada").remove(),dataMensagens=null,dataMensagens=getData("Mensagens",null),$("#Mensagem_wrapper #mensagem_remetente").html(""),$("#Mensagem_wrapper #mensagem_destinatario").html(""),$("#Mensagem_wrapper #mensagem_assunto").html(""),$("#Mensagem_wrapper #Mensagem").html(""),$("#frm_Post_Mensagens #id").val(""),$("#frm_Post_Mensagens #action").val(""),$("#frm_Post_Mensagens #remetente").val(""),$("#frm_Post_Mensagens #assunto").val(""),$("#frm_Post_Mensagens #mensagem").val(""),$("#frm_Post_Mensagens #lida").val(""),$("#frm_Post_Mensagens #cxEntrada").val(""),$("#frm_Post_Mensagens #cxEnviada").val(""),$("#frm_Post_Mensagens #tipoMensagem").val(""),$("#frm_Post_Mensagens #data").val(""),$("#frm_Post_Mensagens #proprietario").val(""),$("#frm_Post_Mensagens #destinatarios").val(""),$(".nextAccept").trigger("click"),$(".nextAccept").removeClass("nextAccept"),carregaMensagens(),mensagem("Mensagem excluida com sucesso!","OK","bt_ok","sucesso"),loading("final"))}}).then(function(){dataMensagens=null,dataMensagens=getData("Mensagens",null),loading("final")})}function getAlunoByUsuario(){for(var a=0;a<dataUsuario.length;a++)if("Aluno"==usuario&&null!=dataUsuario[a].aluno){if(dataUsuario[a].idusuario==userID)return dataUsuario[a].aluno.idAluno}else if("Professor"==usuario&&null!=dataUsuario[a].professor&&dataUsuario[a].idusuario==userID)return dataUsuario[a].professor.idprofessorFuncionario}function getNomeByNomeUsuario(a,b){for(var c=a.split(";"),d="",e=0;e<c.length;e++)for(var f=0;f<dataUsuario.length;f++)dataUsuario[f].login==c[e]&&(null!=dataUsuario[f].aluno?d+=dataUsuario[f].aluno.nome+"; ":null!=dataUsuario[f].professor&&(d+=dataUsuario[f].professor.nome+"; "),1==b&&$("#tela_over #Mensagem_wrapper #Nova_frame #destinatarios option[value='"+dataUsuario[f].idusuario+"']").prop("selected",!0));return d}function limparCampos(){$("#tela_over #Mensagem_wrapper #Nova_frame #assunto").val(""),$("#tela_over #Mensagem_wrapper #Nova_frame #mensagem").val(""),$("#pesquisaParaMensagem").val(""),$(".ui-multiselect-checkboxes li").css("display","block"),$(":checkbox").removeAttr("checked"),$(".ui-multiselect span").eq(1).text("Para")}var dataUsuario=getData("Usuario",null),userID=usuarioId,alunoID=getAlunoByUsuario(),dataMensagens,dataMensagensEntrada,dataMensagensSaida,observacaoProducao=!1;carregaMensagens();var IdMsg=GetURLParameter("ID"),PLixo=0,arrayUsuariosID=[],arrayUsuariosNome=[],SelMSGAcao=0;$(document).ready(function(){$("#Nav_menu div").click(function(){"bt_Excluir"==$(this).attr("id")&&$(".msg_selecionada").length>0&&(loading("inicial"),setTimeout(ExcluirMensagem,1e3)),"bt_Excluir"!=$(this).attr("id")&&$(".msg_selecionada").length>0&&(1==$(this).hasClass("estado_ativo")?$(this).removeClass("estado_ativo"):($("#Nav_menu div").removeClass("estado_ativo"),$(this).addClass("estado_ativo"))),$("#menu_responder").hide()}),$("#bt_Responder").click(function(){1==$("#bt_Responder").hasClass("estado_ativo")&&$(".msg_selecionada").length>0?$("#menu_responder").show():$("#menu_responder").hide()}),$("span#responder").click(function(){$("#tela_over").show(),$("#menu_responder").hide(),$("#Nav_menu div").removeClass("estado_ativo"),setMSGSend(1)}),$("span#responder_todos").click(function(){$("#tela_over").show(),$("#menu_responder").hide(),$("#Nav_menu div").removeClass("estado_ativo"),setMSGSend(2)}),$("span#encaminhar").click(function(){$("#tela_over").show(),$("#menu_responder").hide(),$("#Nav_menu div").removeClass("estado_ativo"),setMSGSend(3)}),$("#bt_resp_cancelar").click(function(){$("#Nav_menu div").removeClass("estado_ativo"),$("#tela_over").hide()}),$("#bt_Escrever").click(function(){$("#tela_over").show(),setMSGSend(4),$("#Nav_menu div").removeClass("estado_ativo")}),$("#bt_enviar_cancelar").click(function(){return limparCampos(),$("#tela_over").hide(),observacaoProducao=!1,!1}),$("#bt_resp_enviar").click(function(){ResponderMensagem(),$("#Nav_menu div").removeClass("estado_ativo")}),$("body").delegate(".ui-multiselect-none","click",function(){return $(":checkbox").removeAttr("checked"),$("#pesquisaParaMensagem").val(""),$("#pesquisaParaMensagem").focus(),$(".ui-multiselect-checkboxes li").css("display","block"),$(".ui-multiselect span").eq(1).text("Para"),!1}),$("#Col_Menu div").click(function(){$("#Col_Menu div").removeClass("estado_ativo"),$(this).toggleClass("estado_ativo"),"CaixaDeEntrada"==$(this).attr("id")?ListarCaixaEntrada():"Enviadas"==$(this).attr("id")&&ListarEnviadas(""),$("#Mensagem_wrapper #mensagem_remetente").html(""),$("#Mensagem_wrapper #mensagem_destinatario").html(""),$("#Mensagem_wrapper #mensagem_assunto").html(""),$("#Mensagem_wrapper #Mensagem").html(""),PLixo=0});for(var a=0;a<dataUsuario.length;a++){var b=!1;null!=dataUsuario[a].professor?(arrayUsuariosID[arrayUsuariosID.length]=dataUsuario[a].professor.idprofessorFuncionario,arrayUsuariosNome[arrayUsuariosNome.length]=dataUsuario[a].professor.nome,b=!0):null!=dataUsuario[a].aluno&&(arrayUsuariosID[arrayUsuariosID.length]=dataUsuario[a].aluno.idAluno,arrayUsuariosNome[arrayUsuariosNome.length]=dataUsuario[a].aluno.nome,b=!0),b&&$("#tela_over #Mensagem_wrapper #destinatarios").append('<option title="'+dataUsuario[a].perfil.perfil+'" value="'+dataUsuario[a].idusuario+'">'+arrayUsuariosNome[arrayUsuariosNome.length-1]+"</option>")}if($("#tela_over #Mensagem_wrapper #destinatarios").append($("#tela_over #Mensagem_wrapper #destinatarios option").remove().sort(function(a,b){var c=$(a).text(),d=$(b).text();return c>d?1:c<d?-1:0})),ListarCaixaEntrada(),window.setTimeout(function(){void 0!=IdMsg&&($(".caixa_mensagem[msgid='"+IdMsg+"']").trigger("click"),scrollBarMensagem.mCustomScrollbar("scrollTo",$(".caixa_mensagem[msgid='"+IdMsg+"']")))},1e3),null!=localStorage.getItem("producaoMensagem")&&""!=localStorage.getItem("producaoMensagem")&&(localStorage.setItem("observacaoProducao",localStorage.getItem("producaoMensagem")),localStorage.setItem("producaoMensagem",""),observacaoProducao=!0,$("#bt_Escrever").trigger("click"),window.setTimeout(function(){var a;$.ajax({url:path+"ProducaoAluno/"+localStorage.getItem("observacaoProducao"),async:!1,crossDomain:!0,type:"GET",success:function(b){a=b}});var b;$.ajax({url:path+"Usuario/aluno/"+a.aluno.idAluno,async:!1,crossDomain:!0,type:"GET",success:function(a){b=a}}),$("[id^='ui-multiselect-destinatarios-option'][value="+b.idusuario+"]").trigger("click"),$("#frm_Envia_Mensagens #assunto").val(a.tipo.tipo+" - "+a.texto)},1500)),null!=localStorage.getItem("respostaObservacao")&&""!=localStorage.getItem("respostaObservacao")){var c=localStorage.getItem("respostaObservacao");localStorage.setItem("respostaObservacao",""),window.setTimeout(function(){$("[msgid="+c+"]").trigger("click"),$("#responder").trigger("click")},1500)}});